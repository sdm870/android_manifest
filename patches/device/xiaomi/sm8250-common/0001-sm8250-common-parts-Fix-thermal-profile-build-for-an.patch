From 7fc9da25c7385d5fbc4f4f590ab47b4487a7fa0b Mon Sep 17 00:00:00 2001
From: TheScarastic <warabhishek@gmail.com>
Date: Wed, 6 Oct 2021 07:27:59 +0000
Subject: [PATCH] sm8250-common: parts: Fix thermal profile build for
 android-12

https://android.googlesource.com/platform/frameworks/base/+/bfc9e5936118cdb6de6fa65261f849e837053b7c

Change-Id: Idb137239c916f94d0bbef2166bb688f381e4ad28
---
 .../settings/thermal/ThermalService.java      | 26 ++++++++++++-------
 1 file changed, 16 insertions(+), 10 deletions(-)

diff --git a/parts/src/org/lineageos/settings/thermal/ThermalService.java b/parts/src/org/lineageos/settings/thermal/ThermalService.java
index bc29510..cba9044 100644
--- a/parts/src/org/lineageos/settings/thermal/ThermalService.java
+++ b/parts/src/org/lineageos/settings/thermal/ThermalService.java
@@ -18,6 +18,9 @@ package org.lineageos.settings.thermal;
 
 import android.app.ActivityManager;
 import android.app.ActivityTaskManager;
+import android.app.ActivityTaskManager.RootTaskInfo;
+import android.app.IActivityTaskManager;
+import android.app.TaskStackListener;
 import android.app.Service;
 import android.app.TaskStackListener;
 import android.content.BroadcastReceiver;
@@ -37,6 +40,8 @@ public class ThermalService extends Service {
     private String mPreviousApp;
     private ThermalUtils mThermalUtils;
 
+    private IActivityTaskManager mActivityTaskManager;
+
     private BroadcastReceiver mIntentReceiver = new BroadcastReceiver() {
         @Override
         public void onReceive(Context context, Intent intent) {
@@ -49,7 +54,8 @@ public class ThermalService extends Service {
     public void onCreate() {
         if (DEBUG) Log.d(TAG, "Creating service");
         try {
-            ActivityTaskManager.getService().registerTaskStackListener(mTaskListener);
+            mActivityTaskManager = ActivityTaskManager.getService();
+            mActivityTaskManager.registerTaskStackListener(mTaskListener);
         } catch (RemoteException e) {
             // Do nothing
         }
@@ -80,15 +86,15 @@ public class ThermalService extends Service {
         @Override
         public void onTaskStackChanged() {
             try {
-                final ActivityManager.StackInfo focusedStack =
-                        ActivityTaskManager.getService().getFocusedStackInfo();
-                if (focusedStack != null && focusedStack.topActivity != null) {
-                    ComponentName taskComponentName = focusedStack.topActivity;
-                    String foregroundApp = taskComponentName.getPackageName();
-                    if (!foregroundApp.equals(mPreviousApp)) {
-                        mThermalUtils.setThermalProfile(foregroundApp);
-                        mPreviousApp = foregroundApp;
-                    }
+                final RootTaskInfo info = mActivityTaskManager.getFocusedRootTaskInfo();
+                if (info == null || info.topActivity == null) {
+                    return;
+                }
+
+                String foregroundApp = info.topActivity.getPackageName();
+                if (!foregroundApp.equals(mPreviousApp)) {
+                    mThermalUtils.setThermalProfile(foregroundApp);
+                    mPreviousApp = foregroundApp;
                 }
             } catch (Exception e) {}
         }
-- 
2.25.1

